<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal dos S√≥cios - Salvador Produ√ß√µes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* Estilos mantidos iguais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-app {
            display: none;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header-left h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .header-left p {
            color: #666;
            font-size: 1.1em;
        }

        .user-info {
            text-align: right;
            color: #666;
        }

        .user-info .user-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }

        .upload-area {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .processing-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-processing {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }
        .neutral { color: #3498db; }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f8f9ff;
        }
        
        .currency {
            text-align: right;
            font-family: monospace;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #2ecc71;
        }

        .notification.error {
            background: #e74c3c;
        }

        .recent-uploads {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .upload-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .upload-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-info {
                text-align: center;
                margin-top: 15px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1>Portal dos S√≥cios</h1>
            <p style="color: #666; margin-bottom: 30px;">Salvador Produ√ß√µes e Entretenimento</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="userType">Tipo de Acesso:</label>
                    <select id="userType" required>
                        <option value="">Selecione...</option>
                        <option value="socio">S√≥cio/Parceiro</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="userName">Nome/Empresa:</label>
                    <select id="userName" required>
                        <option value="">Selecione seu acesso...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accessCode">C√≥digo de Acesso:</label>
                    <input type="password" id="accessCode" placeholder="Digite o c√≥digo fornecido" required>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Acessar Portal</button>
            </form>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <h1>Portal dos S√≥cios</h1>
                    <p>Salvador Produ√ß√µes e Entretenimento - Dashboard Financeiro</p>
                </div>
                <div class="user-info">
                    <div class="user-name" id="currentUser"></div>
                    <div id="userRole"></div>
                    <button class="btn btn-secondary" onclick="logout()" style="margin-top: 10px;">Sair</button>
                </div>
            </div>
            
            <!-- Se√ß√£o de Upload (apenas para admins) -->
            <div id="uploadSection" class="upload-section" style="display: none;">
                <h3 style="margin-bottom: 20px;">Atualizar Dados - Upload de Relat√≥rios PDF</h3>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple>
                    <div class="upload-icon">üìÑ</div>
                    <h4>Arraste arquivos PDF aqui ou clique para selecionar</h4>
                    <p>Suporta m√∫ltiplos relat√≥rios de eventos em formato PDF</p>
                </div>
                
                <div id="processingStatus" class="processing-status">
                    <div id="statusMessage"></div>
                    <div id="progressBar" style="width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 10px; display: none;">
                        <div id="progressFill" style="height: 100%; background: #667eea; border-radius: 5px; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>

                <div class="recent-uploads">
                    <h4>Uploads Recentes:</h4>
                    <div id="recentUploads">
                        <p style="color: #999; font-style: italic;">Nenhum upload realizado ainda</p>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="exportToExcel()">Exportar Excel</button>
                <button class="btn" onclick="generateDRE()">Ver DRE</button>
                <button class="btn" onclick="refreshData()">Atualizar</button>
                <div style="margin-left: auto;">
                    <span style="color: #666;">√öltima atualiza√ß√£o: </span>
                    <span id="lastUpdate"></span>
                </div>
            </div>
            
            <div class="summary-cards">
                <div class="card">
                    <h3>Receita Total</h3>
                    <div class="value positive" id="totalRevenue">R$ 0,00</div>
                    <small>Consolidado 2025</small>
                </div>
                <div class="card">
                    <h3>Despesa Total</h3>
                    <div class="value negative" id="totalExpense">R$ 0,00</div>
                    <small>Consolidado 2025</small>
                </div>
                <div class="card">
                    <h3>Resultado L√≠quido</h3>
                    <div class="value" id="netResult">R$ 0,00</div>
                    <small>Lucro/Preju√≠zo</small>
                </div>
                <div class="card">
                    <h3>Margem L√≠quida</h3>
                    <div class="value neutral" id="netMargin">0,00%</div>
                    <small>Rentabilidade</small>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">Vis√£o Geral</button>
                <button class="tab" onclick="showTab('events')">Meus Eventos</button>
                <button class="tab" onclick="showTab('partners')">Parceiros</button>
                <button class="tab" onclick="showTab('dre')">DRE</button>
            </div>
            
            <div id="overview" class="tab-content active">
                <div class="table-container">
                    <table id="eventsTable">
                        <thead>
                            <tr>
                                <th>Evento</th>
                                <th>Data</th>
                                <th>Receita</th>
                                <th>Despesa</th>
                                <th>Resultado</th>
                                <th>Margem</th>
                                <th>Minha Participa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="events" class="tab-content">
                <div class="table-container">
                    <table id="myEventsTable">
                        <thead>
                            <tr>
                                <th>Evento</th>
                                <th>Minha %</th>
                                <th>Meu Resultado</th>
                                <th>Status Pagamento</th>
                                <th>Valor a Receber</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="partners" class="tab-content">
                <div class="table-container">
                    <table id="partnersTable">
                        <thead>
                            <tr>
                                <th>Parceiro</th>
                                <th>Eventos</th>
                                <th>% M√©dio</th>
                                <th>Resultado Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="dre" class="tab-content">
                <div class="table-container">
                    <h3 style="padding: 20px; margin: 0;">Demonstra√ß√£o do Resultado do Exerc√≠cio (DRE) - 2025</h3>
                    <table id="dreTable">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Conta</th>
                                <th style="text-align: right;">Valor (R$)</th>
                                <th style="text-align: right;">% Receita</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados iniciais dos eventos (base atual)
        let eventsData = [
            {
                name: "Arrocha Safad√£o 2025",
                date: "2025-07-31",
                revenue: 2751929.52,
                expense: 2578196.46,
                result: 173733.06,
                type: "Show",
                partners: {
                    "Nei √Åvila": { percentage: 20, result: 34746.61, paid: true },
                    "Salvador Produ√ß√µes": { percentage: 30, result: 52119.92, paid: true },
                    "Camarote Shows e Eventos": { percentage: 50, result: 86866.53, paid: true }
                }
            },
            {
                name: "Baile da Santinha 2025",
                date: "2025-07-31",
                revenue: 2448789.80,
                expense: 3597611.91,
                result: -1148822.11,
                type: "Baile",
                partners: {
                    "Salvador Produ√ß√µes": { percentage: 100, result: -1148822.11, paid: false }
                }
            },
            {
                name: "Bloco Timbalada - 2025",
                date: "2025-07-31",
                revenue: 1056650.00,
                expense: 992938.15,
                result: 63711.85,
                type: "Bloco",
                partners: {
                    "Salvador Produ√ß√µes": { percentage: 30, result: 19113.56, paid: true },
                    "Pilar das Produ√ß√µes": { percentage: 70, result: 44598.30, paid: true }
                }
            },
            {
                name: "Camarote Glamour Salvador 2025",
                date: "2025-07-31",
                revenue: 10703511.39,
                expense: 14125980.11,
                result: -3422468.72,
                type: "Camarote",
                partners: {
                    "Nei de Moreira Avila": { percentage: 20, result: -684493.74, paid: false },
                    "Salvador Produ√ß√µes": { percentage: 80, result: -2737974.98, paid: false }
                }
            },
            // Adicionar outros eventos conforme necess√°rio
        ];

        // Usu√°rios e permiss√µes
        const users = {
            'Salvador Produ√ß√µes': { type: 'admin', code: 'admin2025' },
            'Nei √Åvila': { type: 'socio', code: 'nei2025' },
            'Camarote Shows e Eventos': { type: 'socio', code: 'camarote2025' },
            'Pilar das Produ√ß√µes': { type: 'socio', code: 'pilar2025' },
            'Nei de Moreira Avila': { type: 'socio', code: 'neim2025' },
            'MP Produ√ß√µes': { type: 'socio', code: 'mp2025' },
            'On Line Entretenimento': { type: 'socio', code: 'online2025' },
            'Se Liga Produ√ß√µes': { type: 'socio', code: 'seliga2025' },
            '2DC Produ√ß√µes': { type: 'socio', code: '2dc2025' },
            'Pedra do Mar Produ√ß√µes': { type: 'socio', code: 'pedra2025' }
        };

        let currentUser = null;
        let recentUploads = [];

        // Fun√ß√µes de utilit√°rio
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Sistema de Login
        document.getElementById('userType').addEventListener('change', function() {
            const userName = document.getElementById('userName');
            userName.innerHTML = '<option value="">Selecione seu acesso...</option>';
            
            if (this.value) {
                Object.entries(users).forEach(([name, data]) => {
                    if (data.type === this.value) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        userName.appendChild(option);
                    }
                });
            }
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const userName = document.getElementById('userName').value;
            const accessCode = document.getElementById('accessCode').value;
            
            if (users[userName] && users[userName].code === accessCode && users[userName].type === userType) {
                currentUser = {
                    name: userName,
                    type: userType
                };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUser').textContent = userName;
                document.getElementById('userRole').textContent = userType === 'admin' ? 'Administrador' : 'S√≥cio/Parceiro';
                
                // Mostrar se√ß√£o de upload apenas para admins
                if (userType === 'admin') {
                    document.getElementById('uploadSection').style.display = 'block';
                }
                
                initializeDashboard();
                showNotification('Login realizado com sucesso!');
            } else {
                showNotification('Credenciais inv√°lidas!', 'error');
            }
        });

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // Sistema de Upload de Arquivos PDF
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
                if (files.length > 0) {
                    processFiles(files);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processFiles(Array.from(e.target.files));
                }
            });
        }

        function processFiles(files) {
            const statusDiv = document.getElementById('processingStatus');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'processing-status status-processing';
            statusMessage.textContent = 'Processando arquivos...';
            progressBar.style.display = 'block';
            
            let processed = 0;
            
            files.forEach((file, index) => {
                setTimeout(() => {
                    // Simula√ß√£o de processamento (na implementa√ß√£o real, aqui seria feito o parsing do PDF)
                    const eventData = simulateEventDataExtraction(file.name);
                    
                    if (eventData) {
                        // Atualizar ou adicionar evento
                        const existingIndex = eventsData.findIndex(e => e.name === eventData.name);
                        if (existingIndex >= 0) {
                            eventsData[existingIndex] = eventData;
                        } else {
                            eventsData.push(eventData);
                        }
                        
                        // Adicionar aos uploads recentes
                        recentUploads.unshift({
                            fileName: file.name,
                            eventName: eventData.name,
                            uploadTime: new Date(),
                            status: 'success'
                        });
                    }
                    
                    processed++;
                    const progress = (processed / files.length) * 100;
                    progressFill.style.width = progress + '%';
                    
                    if (processed === files.length) {
                        statusDiv.className = 'processing-status status-success';
                        statusMessage.textContent = `${processed} arquivo(s) processado(s) com sucesso!`;
                        
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                            progressBar.style.display = 'none';
                            progressFill.style.width = '0%';
                        }, 3000);
                        
                        updateRecentUploads();
                        updateSummaryCards();
                        updateTables();
                        showNotification('Dados atualizados com sucesso!');
                    }
                }, index * 500);
            });
        }

        function simulateEventDataExtraction(fileName) {
            // Esta √© uma simula√ß√£o - na implementa√ß√£o real, aqui seria usado PDF.js para extrair dados
            const eventNames = [
                "Festival Ver√£o 2025",
                "Show Especial",
                "Carnaval Salvador 2025",
                "Ensaio Especial"
            ];
            
            return {
                name: eventNames[Math.floor(Math.random() * eventNames.length)],
                date: new Date().toISOString().split('T')[0],
                revenue: Math.random() * 1000000 + 100000,
                expense: Math.random() * 800000 + 50000,
                result: 0, // Calculado depois
                type: "Evento",
                partners: {
                    "Salvador Produ√ß√µes": { percentage: 50, result: 0, paid: false }
                }
            };
        }

        function updateRecentUploads() {
            const container = document.getElementById('recentUploads');
            
            if (recentUploads.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Nenhum upload realizado ainda</p>';
                return;
            }
            
            let html = '';
            recentUploads.slice(0, 5).forEach(upload => {
                const timeAgo = getTimeAgo(upload.uploadTime);
                html += `
                    <div class="upload-item">
                        <div>
                            <strong>${upload.eventName}</strong><br>
                            <small>${upload.fileName}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #2ecc71;">‚úì Sucesso</div>
                            <small>${timeAgo}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'h√° poucos segundos';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `h√° ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `h√° ${hours} hora${hours > 1 ? 's' : ''}`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `h√° ${days} dia${days > 1 ? 's' : ''}`;
            }
        }

        function initializeDashboard() {
            updateLastUpdate();
            updateSummaryCards();
            updateTables();
            initializeUpload();
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('pt-BR');
        }

        function updateSummaryCards() {
            let totalRevenue = 0;
            let totalExpense = 0;
            
            eventsData.forEach(event => {
                totalRevenue += event.revenue;
                totalExpense += event.expense;
            });
            
            const netResult = totalRevenue - totalExpense;
            const netMargin = totalRevenue > 0 ? (netResult / totalRevenue) : 0;
            
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('netResult').textContent = formatCurrency(netResult);
            document.getElementById('netMargin').textContent = formatPercentage(netMargin);
            
            // Adicionar classe de cor baseada no resultado
            const netResultElement = document.getElementById('netResult');
            netResultElement.className = 'value ' + (netResult >= 0 ? 'positive' : 'negative');
        }

        function updateTables() {
            updateEventsTable();
            updateMyEventsTable();
            updatePartnersTable();
            updateDreTable();
        }

        function updateEventsTable() {
            const tbody = document.querySelector('#eventsTable tbody');
            tbody.innerHTML = '';
            
            eventsData.forEach(event => {
                const margin = event.revenue > 0 ? (event.result / event.revenue) : 0;
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${event.name}</td>
                    <td>${new Date(event.date).toLocaleDateString('pt-BR')}</td>
                    <td class="currency">${formatCurrency(event.revenue)}</td>
                    <td class="currency">${formatCurrency(event.expense)}</td>
                    <td class="currency ${event.result >= 0 ? 'positive' : 'negative'}">${formatCurrency(event.result)}</td>
                    <td>${formatPercentage(margin)}</td>
                    <td>${currentUser && event.partners[currentUser.name] ? formatPercentage(event.partners[currentUser.name].percentage / 100) : 'N/A'}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function updateMyEventsTable() {
            const tbody = document.querySelector('#myEventsTable tbody');
            tbody.innerHTML = '';
            
            if (!currentUser) return;
            
            eventsData.forEach(event => {
                if (event.partners[currentUser.name]) {
                    const partnerData = event.partners[currentUser.name];
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${event.name}</td>
                        <td>${formatPercentage(partnerData.percentage / 100)}</td>
                        <td class="currency ${partnerData.result >= 0 ? 'positive' : 'negative'}">${formatCurrency(partnerData.result)}</td>
                        <td>${partnerData.paid ? 'Pago' : 'Pendente'}</td>
                        <td class="currency">${partnerData.paid ? formatCurrency(0) : formatCurrency(partnerData.result)}</td>
                    `;
                    
                    tbody.appendChild(tr);
                }
            });
        }

        function updatePartnersTable() {
            const tbody = document.querySelector('#partnersTable tbody');
            tbody.innerHTML = '';
            
            // Coletar dados de todos os parceiros
            const partnersData = {};
            
            eventsData.forEach(event => {
                Object.entries(event.partners).forEach(([partnerName, partnerData]) => {
                    if (!partnersData[partnerName]) {
                        partnersData[partnerName] = {
                            events: 0,
                            totalPercentage: 0,
                            totalResult: 0,
                            paidEvents: 0
                        };
                    }
                    
                    partnersData[partnerName].events++;
                    partnersData[partnerName].totalPercentage += partnerData.percentage;
                    partnersData[partnerName].totalResult += partnerData.result;
                    if (partnerData.paid) partnersData[partnerName].paidEvents++;
                });
            });
            
            // Preencher a tabela
            Object.entries(partnersData).forEach(([partnerName, data]) => {
                const avgPercentage = data.events > 0 ? data.totalPercentage / data.events : 0;
                const status = data.paidEvents === data.events ? 'Quitado' : 
                              data.paidEvents > 0 ? 'Parcial' : 'Pendente';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${partnerName}</td>
                    <td>${data.events}</td>
                    <td>${formatPercentage(avgPercentage / 100)}</td>
                    <td class="currency ${data.totalResult >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.totalResult)}</td>
                    <td>${status}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function updateDreTable() {
            const tbody = document.querySelector('#dreTable tbody');
            tbody.innerHTML = '';
            
            let totalRevenue = 0;
            let totalExpense = 0;
            
            eventsData.forEach(event => {
                totalRevenue += event.revenue;
                totalExpense += event.expense;
            });
            
            const netResult = totalRevenue - totalExpense;
            const netMargin = totalRevenue > 0 ? (netResult / totalRevenue) : 0;
            
            const rows = [
                { account: 'Receita Total', value: totalRevenue, percentage: 100 },
                { account: 'Custo dos Eventos', value: -totalExpense, percentage: -(totalExpense / totalRevenue * 100) },
                { account: 'Resultado Operacional', value: netResult, percentage: netMargin * 100 },
                { account: 'Impostos (estimado)', value: -(netResult * 0.15), percentage: -15 },
                { account: 'Resultado L√≠quido', value: netResult * 0.85, percentage: netMargin * 100 * 0.85 }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.account}</td>
                    <td class="currency ${row.value >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.value)}</td>
                    <td class="currency">${row.percentage.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showTab(tabId) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar a aba selecionada
            document.getElementById(tabId).classList.add('active');
            
            // Atualizar estado dos bot√µes de aba
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        function exportToExcel() {
            // Criar uma planilha com os dados
            const ws = XLSX.utils.json_to_sheet(eventsData.map(event => ({
                'Evento': event.name,
                'Data': event.date,
                'Receita': event.revenue,
                'Despesa': event.expense,
                'Resultado': event.result,
                'Tipo': event.type
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Eventos");
            
            // Salvar o arquivo
            XLSX.writeFile(wb, "relatorio_eventos.xlsx");
            showNotification('Relat√≥rio exportado com sucesso!');
        }

        function generateDRE() {
            showTab('dre');
            showNotification('DRE gerado com sucesso!');
        }

        function refreshData() {
            updateLastUpdate();
            updateSummaryCards();
            updateTables();
            showNotification('Dados atualizados!');
        }

        // Inicializar a aplica√ß√£o quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Preencher o dropdown de usu√°rios para administradores
            const adminSelect = document.getElementById('userName');
            Object.entries(users).forEach(([name, data]) => {
                if (data.type === 'admin') {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    adminSelect.appendChild(option);
                }
            });
        });
    </script>
</body>
</html>