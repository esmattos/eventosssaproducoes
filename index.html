<script>
let eventsData = [];
let filteredData = [];

// Lista de correspondências para normalizar tipos de eventos
const tipoMap = {
  "show": "Show",
  "shw": "Show",
  "show musical": "Show",
  "workshop": "Workshop",
  "work shop": "Workshop",
  "palestra": "Palestra",
  "palestr": "Palestra",
  "concerto": "Concerto",
  "concerto musical": "Concerto",
  "": "Não informado",
  null: "Não informado"
};

document.getElementById("fileInput").addEventListener("change", handleFiles);

function handleFiles(event) {
  const files = event.target.files;
  [...files].forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);

      json.forEach(row => {
        // Normaliza o tipo usando o mapa
        const rawTipo = row.Tipo?.toLowerCase().trim() || "";
        const tipoNormalizado = tipoMap[rawTipo] || "Não informado";

        eventsData.push({
          name: row.Evento || "Sem Nome",
          revenue: parseFloat(row.Receita || 0),
          expense: parseFloat(row.Despesa || 0),
          result: parseFloat(row.Resultado || (row.Receita - row.Despesa)),
          type: tipoNormalizado
        });
      });

      filterData();
      updateEventFilter();
      updateCompareSelect();
    };
    reader.readAsArrayBuffer(file);
  });
}

function formatCurrency(value) {
  return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function updateSummary() {
  const totalRevenue = filteredData.reduce((s, e) => s + e.revenue, 0);
  const totalExpense = filteredData.reduce((s, e) => s + e.expense, 0);
  const netResult = totalRevenue - totalExpense;
  const netMargin = totalRevenue > 0 ? (netResult / totalRevenue) * 100 : 0;

  document.getElementById("totalRevenue").textContent = formatCurrency(totalRevenue);
  document.getElementById("totalExpense").textContent = formatCurrency(totalExpense);
  document.getElementById("netResult").textContent = formatCurrency(netResult);
  document.getElementById("netResult").className = netResult >= 0 ? "positive" : "negative";
  document.getElementById("netMargin").textContent = netMargin.toFixed(2) + "%";
}

function updateOverviewTable() {
  const tbody = document.querySelector("#eventsTable tbody");
  tbody.innerHTML = "";
  filteredData.forEach(e => {
    const margin = e.revenue > 0 ? (e.result / e.revenue) * 100 : 0;
    tbody.innerHTML += `
      <tr>
        <td>${e.name}</td>
        <td>${formatCurrency(e.revenue)}</td>
        <td>${formatCurrency(e.expense)}</td>
        <td class="${e.result >= 0 ? "positive" : "negative"}">${formatCurrency(e.result)}</td>
        <td>${margin.toFixed(2)}%</td>
        <td>${e.type}</td>
      </tr>
    `;
  });
}

function updateEventFilter() {
  const filter = document.getElementById("eventFilter");
  filter.innerHTML = '<option value="all">Todos os Eventos</option>';
  const uniqueNames = [...new Set(eventsData.map(e => e.name))];
  uniqueNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    filter.appendChild(opt);
  });
}

function updateCompareSelect() {
  const select = document.getElementById("compareSelect");
  select.innerHTML = "";
  eventsData.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.name;
    opt.textContent = e.name;
    select.appendChild(opt);
  });
}

function filterData() {
  const filter = document.getElementById("eventFilter").value;
  filteredData = filter === "all" ? eventsData : eventsData.filter(e => e.name === filter);
  updateSummary();
  updateOverviewTable();
}

function compareEvents() {
  const selected = [...document.getElementById("compareSelect").selectedOptions].map(o => o.value);
  const compareData = eventsData.filter(e => selected.includes(e.name));
  let html = "<table><tr><th>Evento</th><th>Receita</th><th>Despesa</th><th>Resultado</th><th>Tipo</th></tr>";
  compareData.forEach(e => {
    html += `<tr>
      <td>${e.name}</td>
      <td>${formatCurrency(e.revenue)}</td>
      <td>${formatCurrency(e.expense)}</td>
      <td class="${e.result >= 0 ? "positive" : "negative"}">${formatCurrency(e.result)}</td>
      <td>${e.type}</td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("compareContainer").innerHTML = html;
}

function updateData() {
  filterData();
}

function showTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
}
</script>
