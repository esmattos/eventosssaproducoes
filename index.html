<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Financeiro - SSA Produções</title>

  <!-- CSS simples para layout -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
    header { background: #667eea; color: white; padding: 15px; text-align: center; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    .btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
    .btn:hover { background: #5563c1; }
    .cards { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; }
    .card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .positive { color: green; }
    .negative { color: red; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #667eea; color: white; }
    tr:hover { background: #f9f9f9; }
    select { padding: 8px; margin: 5px; }
    #tabs button { margin: 5px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Dashboard Financeiro - SSA Produções</h1>
    <p>Importe seus arquivos Excel ou CSV para visualizar os eventos</p>
  </header>

  <div class="container">
    <!-- Upload -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple />
    <button class="btn" onclick="updateData()">Atualizar Dados</button>

    <!-- Resumo -->
    <div class="cards">
      <div class="card">
        <h3>Receita Total</h3>
        <p id="totalRevenue">R$ 0,00</p>
      </div>
      <div class="card">
        <h3>Despesa Total</h3>
        <p id="totalExpense">R$ 0,00</p>
      </div>
      <div class="card">
        <h3>Resultado Líquido</h3>
        <p id="netResult">R$ 0,00</p>
      </div>
      <div class="card">
        <h3>Margem Líquida</h3>
        <p id="netMargin">0%</p>
      </div>
    </div>

    <!-- Filtros -->
    <div>
      <select id="eventFilter" onchange="filterData()">
        <option value="all">Todos os Eventos</option>
      </select>
    </div>

    <!-- Abas -->
    <div id="tabs">
      <button class="btn" onclick="showTab('overview')">Visão Geral</button>
      <button class="btn" onclick="showTab('compare')">Comparar Eventos</button>
    </div>

    <!-- Tabela Geral -->
    <div id="overview" class="tab-content active">
      <table id="eventsTable">
        <thead>
          <tr>
            <th>Evento</th>
            <th>Receita</th>
            <th>Despesa</th>
            <th>Resultado</th>
            <th>Margem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Comparação -->
    <div id="compare" class="tab-content">
      <h3>Selecione eventos para comparar:</h3>
      <select id="compareSelect" multiple></select>
      <button class="btn" onclick="compareEvents()">Comparar</button>
      <div id="compareContainer"></div>
    </div>
  </div>

  <script>
    let eventsData = [];
    let filteredData = [];

    document.getElementById("fileInput").addEventListener("change", handleFiles);

    function handleFiles(event) {
      const files = event.target.files;
      [...files].forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          json.forEach(row => {
            eventsData.push({
              name: row.Evento || "Sem Nome",
              revenue: parseFloat(row.Receita || 0),
              expense: parseFloat(row.Despesa || 0),
              result: parseFloat(row.Resultado || (row.Receita - row.Despesa)),
              type: row.Tipo || "Não informado"
            });
          });

          filterData();
          updateEventFilter();
          updateCompareSelect();
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function formatCurrency(value) {
      return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function updateSummary() {
      const totalRevenue = filteredData.reduce((s, e) => s + e.revenue, 0);
      const totalExpense = filteredData.reduce((s, e) => s + e.expense, 0);
      const netResult = totalRevenue - totalExpense;
      const netMargin = totalRevenue > 0 ? (netResult / totalRevenue) * 100 : 0;

      document.getElementById("totalRevenue").textContent = formatCurrency(totalRevenue);
      document.getElementById("totalExpense").textContent = formatCurrency(totalExpense);
      document.getElementById("netResult").textContent = formatCurrency(netResult);
      document.getElementById("netResult").className = netResult >= 0 ? "positive" : "negative";
      document.getElementById("netMargin").textContent = netMargin.toFixed(2) + "%";
    }

    function updateOverviewTable() {
      const tbody = document.querySelector("#eventsTable tbody");
      tbody.innerHTML = "";
      filteredData.forEach(e => {
        const margin = e.revenue > 0 ? (e.result / e.revenue) * 100 : 0;
        tbody.innerHTML += `
          <tr>
            <td>${e.name}</td>
            <td>${formatCurrency(e.revenue)}</td>
            <td>${formatCurrency(e.expense)}</td>
            <td class="${e.result >= 0 ? "positive" : "negative"}">${formatCurrency(e.result)}</td>
            <td>${margin.toFixed(2)}%</td>
          </tr>
        `;
      });
    }

    function updateEventFilter() {
      const filter = document.getElementById("eventFilter");
      filter.innerHTML = '<option value="all">Todos os Eventos</option>';
      eventsData.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.name;
        opt.textContent = e.name;
        filter.appendChild(opt);
      });
    }

    function updateCompareSelect() {
      const select = document.getElementById("compareSelect");
      select.innerHTML = "";
      eventsData.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.name;
        opt.textContent = e.name;
        select.appendChild(opt);
      });
    }

    function filterData() {
      const filter = document.getElementById("eventFilter").value;
      filteredData = filter === "all" ? eventsData : eventsData.filter(e => e.name === filter);
      updateSummary();
      updateOverviewTable();
    }

    function compareEvents() {
      const selected = [...document.getElementById("compareSelect").selectedOptions].map(o => o.value);
      const compareData = eventsData.filter(e => selected.includes(e.name));
      let html = "<table><tr><th>Evento</th><th>Receita</th><th>Despesa</th><th>Resultado</th></tr>";
      compareData.forEach(e => {
        html += `<tr>
          <td>${e.name}</td>
          <td>${formatCurrency(e.revenue)}</td>
          <td>${formatCurrency(e.expense)}</td>
          <td class="${e.result >= 0 ? "positive" : "negative"}">${formatCurrency(e.result)}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("compareContainer").innerHTML = html;
    }

    function updateData() {
      filterData();
    }

    function showTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
    }
  </script>
</body>
</html>
